<!doctype html><html lang=ja class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4"><meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=https://omni-jp.github.io/favicons/favicon.ico>
<link rel=apple-touch-icon href=https://omni-jp.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-192x192.png sizes=192x192>
<title>UEのIPアドレスの割り当て -- free5GC編 -- | OMNI JP</title><meta property="og:title" content="UEのIPアドレスの割り当て -- free5GC編 --">
<meta property="og:description" content="はじめに 5GではUEのIPアドレスは、どのような仕組みで割り当てられるのでしょうか? 5GCがDHCPサーバーの機能を保有しているのでしょうか? はたまた、5GCとは別にRADIUSサーバーが存在しており、5GCとRADIUSサーバーが連携することでIPアドレスが割り当てられるのでしょうか?
UEのIPアドレスの割り当てについて、free5GCではどのように実現しているのか解説したいと思います。
5Gの規格ではどうなっているのか? T.B.D
SMFの実装を追ってみる SMFのディレクトリを探索してみましょう。
github.com/free5gc/smf/ +- context/ +- ip_allocator.go contextディレクトリ配下にip_allocator.goという、そのものズバリなソースコードがありますね。まずは構造体を見てみましょう。
type IPAllocator struct { ipNetwork *net.IPNet g *_IDPool } いかにもIPアドレスを割り当てそうな名前の構造体です。 メンバーとしてipNetworkという名前のネットワークアドレスとgという名前のIPアドレスのプールらしきものを保有しています。 この構造体を使って割り当てを行っていると考えて間違いないでしょう。
ネットワークアドレスはわかるとして、この_IDPoolとは具体的になにものなのか見てみましょう。
type _IDPool struct { minValue int64 maxValue int64 isUsed map[int64]bool } ふむふむ。最大値と最小値らしきものを保有してますね。 他にもisUsedというboolean型のマップも持っています。これはIPアドレスが実際に使用されているかどうかを判定するためのものでしょうか。 それにしても不思議です。IPアドレスを表現する型であれば4byteか16byteのbyte列となるはずです。しかし、なぜかint64になっています。
int64の謎は後で詳しく調べることにして、この_IDPoolのメソッドを見てみましょう。
func (i *_IDPool) allocate() (id int64, err error) { for id := i.minValue; id <= i.maxValue; id++ { if _, exist := i.isUsed[id]; !exist { i.isUsed[id] = true return id, nil } } return 0, errors.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://omni-jp.github.io/blog/2021/11/25/ue%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6-free5gc%E7%B7%A8/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2021-11-25T15:40:00+09:00">
<meta property="article:modified_time" content="2021-11-25T17:06:17+09:00"><meta property="og:site_name" content="OMNI JP">
<meta itemprop=name content="UEのIPアドレスの割り当て -- free5GC編 --">
<meta itemprop=description content="はじめに 5GではUEのIPアドレスは、どのような仕組みで割り当てられるのでしょうか? 5GCがDHCPサーバーの機能を保有しているのでしょうか? はたまた、5GCとは別にRADIUSサーバーが存在しており、5GCとRADIUSサーバーが連携することでIPアドレスが割り当てられるのでしょうか?
UEのIPアドレスの割り当てについて、free5GCではどのように実現しているのか解説したいと思います。
5Gの規格ではどうなっているのか? T.B.D
SMFの実装を追ってみる SMFのディレクトリを探索してみましょう。
github.com/free5gc/smf/ +- context/ +- ip_allocator.go contextディレクトリ配下にip_allocator.goという、そのものズバリなソースコードがありますね。まずは構造体を見てみましょう。
type IPAllocator struct { ipNetwork *net.IPNet g *_IDPool } いかにもIPアドレスを割り当てそうな名前の構造体です。 メンバーとしてipNetworkという名前のネットワークアドレスとgという名前のIPアドレスのプールらしきものを保有しています。 この構造体を使って割り当てを行っていると考えて間違いないでしょう。
ネットワークアドレスはわかるとして、この_IDPoolとは具体的になにものなのか見てみましょう。
type _IDPool struct { minValue int64 maxValue int64 isUsed map[int64]bool } ふむふむ。最大値と最小値らしきものを保有してますね。 他にもisUsedというboolean型のマップも持っています。これはIPアドレスが実際に使用されているかどうかを判定するためのものでしょうか。 それにしても不思議です。IPアドレスを表現する型であれば4byteか16byteのbyte列となるはずです。しかし、なぜかint64になっています。
int64の謎は後で詳しく調べることにして、この_IDPoolのメソッドを見てみましょう。
func (i *_IDPool) allocate() (id int64, err error) { for id := i.minValue; id <= i.maxValue; id++ { if _, exist := i.isUsed[id]; !exist { i.isUsed[id] = true return id, nil } } return 0, errors."><meta itemprop=datePublished content="2021-11-25T15:40:00+09:00">
<meta itemprop=dateModified content="2021-11-25T17:06:17+09:00">
<meta itemprop=wordCount content="235">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="UEのIPアドレスの割り当て -- free5GC編 --">
<meta name=twitter:description content="はじめに 5GではUEのIPアドレスは、どのような仕組みで割り当てられるのでしょうか? 5GCがDHCPサーバーの機能を保有しているのでしょうか? はたまた、5GCとは別にRADIUSサーバーが存在しており、5GCとRADIUSサーバーが連携することでIPアドレスが割り当てられるのでしょうか?
UEのIPアドレスの割り当てについて、free5GCではどのように実現しているのか解説したいと思います。
5Gの規格ではどうなっているのか? T.B.D
SMFの実装を追ってみる SMFのディレクトリを探索してみましょう。
github.com/free5gc/smf/ +- context/ +- ip_allocator.go contextディレクトリ配下にip_allocator.goという、そのものズバリなソースコードがありますね。まずは構造体を見てみましょう。
type IPAllocator struct { ipNetwork *net.IPNet g *_IDPool } いかにもIPアドレスを割り当てそうな名前の構造体です。 メンバーとしてipNetworkという名前のネットワークアドレスとgという名前のIPアドレスのプールらしきものを保有しています。 この構造体を使って割り当てを行っていると考えて間違いないでしょう。
ネットワークアドレスはわかるとして、この_IDPoolとは具体的になにものなのか見てみましょう。
type _IDPool struct { minValue int64 maxValue int64 isUsed map[int64]bool } ふむふむ。最大値と最小値らしきものを保有してますね。 他にもisUsedというboolean型のマップも持っています。これはIPアドレスが実際に使用されているかどうかを判定するためのものでしょうか。 それにしても不思議です。IPアドレスを表現する型であれば4byteか16byteのbyte列となるはずです。しかし、なぜかint64になっています。
int64の謎は後で詳しく調べることにして、この_IDPoolのメソッドを見てみましょう。
func (i *_IDPool) allocate() (id int64, err error) { for id := i.minValue; id <= i.maxValue; id++ { if _, exist := i.isUsed[id]; !exist { i.isUsed[id] = true return id, nil } } return 0, errors.">
<link rel=preload href=https://omni-jp.github.io/scss/main.min.0bf3a2a5ab2cd69979c3f1fda576e6d32e2013c4acd9d77163d19df37a0e190f.css as=style>
<link href=https://omni-jp.github.io/scss/main.min.0bf3a2a5ab2cd69979c3f1fda576e6d32e2013c4acd9d77163d19df37a0e190f.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class="td-page td-blog">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=https://omni-jp.github.io/>
<span class=navbar-logo><svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a"><stop stop-color="#ef2929" offset="0"/><stop stop-color="#ef2929" stop-opacity="0" offset="1"/></linearGradient><radialGradient id="b" cx="30.204" cy="44.565" r="6.566" gradientTransform="matrix(1 0 0 .33846 2.2204e-14 29.482)" gradientUnits="userSpaceOnUse"><stop offset="0"/><stop stop-opacity="0" offset="1"/></radialGradient><radialGradient id="d" cx="27.577" cy="16.049" r="3.8335" gradientTransform="matrix(1.2434 2.1068e-16 -2.1068e-16 1.2434 -6.7138 -3.7428)" gradientUnits="userSpaceOnUse" xlink:href="#a"/><radialGradient id="c" cx="27.577" cy="15.048" r="3.8335" gradientTransform="matrix(1.2434 2.1068e-16 -2.1068e-16 1.2434 -6.7138 -3.7428)" gradientUnits="userSpaceOnUse" xlink:href="#a"/></defs><path d="m20.225 38.956L24.82 24.36l5.3158 14.596" fill="none" stroke="#000" stroke-miterlimit="10"/><path transform="matrix(.68922 0 0 .68922 5.7682 11.069)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="#ef2929" fill-rule="evenodd"/><path transform="matrix(2.3823 0 0 2.3823 -40.922 -20.43)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="none" stroke="url(#d)" stroke-miterlimit="10" stroke-width="1.1813"/><path transform="matrix(4.6576 0 0 4.6576 -103.67 -62.761)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="none" stroke="url(#c)" stroke-miterlimit="10" stroke-width=".60421"/><path transform="matrix(1.5677 0 0 1.5677 -22.257 -31.996)" d="m36.77 44.565a6.566 2.2223.0 11-13.132.0 6.566 2.2223.0 1113.132.0z" fill="url(#b)" fill-rule="evenodd" opacity=".1765"/><path d="m23.812 28.572 2.9075.85514-4.2757 2.9075 5.8149 1.5392-7.1832 2.9075 8.5514.85514" fill="none" stroke="#000" stroke-linejoin="bevel" stroke-miterlimit="10"/></svg></span><span class="text-uppercase font-weight-bold">OMNI JP</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=https://omni-jp.github.io/><span class=active>Home</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://omni-jp.github.io/events/><span>Events</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=https://omni-jp.github.io/blog/><span class=active>Blog</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li>
<span class=tree-root>
<a href=https://omni-jp.github.io/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-blog>Blog</a>
</span>
<ul class="pr-md-3 ul-1">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20211125uee381aeipe382a2e38389e383ace382b9e381aee589b2e3828ae5bd93e381a6-free5gce7b7a8-li>
<span class=td-sidebar-nav-active-item>
<a href=https://omni-jp.github.io/blog/2021/11/25/ue%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6-free5gc%E7%B7%A8/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id=m-blog20211125uee381aeipe382a2e38389e383ace382b9e381aee589b2e3828ae5bd93e381a6-free5gce7b7a8>UEのIPアドレスの割り当て -- free5GC編 --</a>
</span>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210827test-li>
<span>
<a href=https://omni-jp.github.io/blog/2021/08/27/test/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog20210827test>Test</a>
</span>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/omni-jp/omni-jp.github.io/edit/master/content/ja/blog/ip_address_assignment_free5gc/index.md target=_blank><i class="fa fa-edit fa-fw"></i> ページの編集</a>
<a href="https://github.com/omni-jp/omni-jp.github.io/new/master/content/ja/blog/ip_address_assignment_free5gc/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/omni-jp/omni-jp.github.io/issues/new?title=UE%e3%81%aeIP%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e3%81%ae%e5%89%b2%e3%82%8a%e5%bd%93%e3%81%a6%20--%20free5GC%e7%b7%a8%20--" target=_blank><i class="fab fa-github fa-fw"></i> ドキュメントのissueを作成</a>
<a href=https://github.com/omni-jp/omni-jp.github.io/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> プロジェクトのissueを作成</a>
<a id=print href=https://omni-jp.github.io/blog/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a>
</div>
<nav id=TableOfContents>
<ul>
<li><a href=#はじめに>はじめに</a></li>
<li><a href=#5gの規格ではどうなっているのか>5Gの規格ではどうなっているのか?</a></li>
<li><a href=#smfの実装を追ってみる>SMFの実装を追ってみる</a></li>
<li><a href=#まとめ>まとめ</a></li>
<li><a href=#おまけ>おまけ</a></li>
</ul>
</nav>
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main>
<div class=td-content>
<h1>UEのIPアドレスの割り当て -- free5GC編 --</h1>
<div class="td-byline mb-4">
<time datetime=2021-11-25 class=text-muted>Thursday, November 25, 2021</time>
</div>
<h2 id=はじめに>はじめに</h2>
<p>5GではUEのIPアドレスは、どのような仕組みで割り当てられるのでしょうか?
5GCがDHCPサーバーの機能を保有しているのでしょうか?
はたまた、5GCとは別にRADIUSサーバーが存在しており、5GCとRADIUSサーバーが連携することでIPアドレスが割り当てられるのでしょうか?</p>
<p>UEのIPアドレスの割り当てについて、free5GCではどのように実現しているのか解説したいと思います。</p>
<h2 id=5gの規格ではどうなっているのか>5Gの規格ではどうなっているのか?</h2>
<p>T.B.D</p>
<h2 id=smfの実装を追ってみる>SMFの実装を追ってみる</h2>
<p>SMFのディレクトリを探索してみましょう。</p>
<pre tabindex=0><code>github.com/free5gc/smf/
   +- context/
      +- ip_allocator.go
</code></pre><p>contextディレクトリ配下にip_allocator.goという、そのものズバリなソースコードがありますね。まずは構造体を見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>IPAllocator</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>ipNetwork</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IPNet</span>
	<span style=color:#000>g</span>         <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>いかにもIPアドレスを割り当てそうな名前の構造体です。
メンバーとしてipNetworkという名前のネットワークアドレスとgという名前のIPアドレスのプールらしきものを保有しています。
この構造体を使って割り当てを行っていると考えて間違いないでしょう。</p>
<p>ネットワークアドレスはわかるとして、この_IDPoolとは具体的になにものなのか見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>_IDPool</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>minValue</span> <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>maxValue</span> <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>isUsed</span>   <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>bool</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>ふむふむ。最大値と最小値らしきものを保有してますね。
他にもisUsedというboolean型のマップも持っています。これはIPアドレスが実際に使用されているかどうかを判定するためのものでしょうか。
それにしても不思議です。IPアドレスを表現する型であれば4byteか16byteのbyte列となるはずです。しかし、なぜかint64になっています。</p>
<p>int64の謎は後で詳しく調べることにして、この_IDPoolのメソッドを見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>allocate</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>minValue</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>maxValue</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>exist</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>];</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>exist</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;No available value range to allocate id&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>release</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87>delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>このメソッドからわかることは、allocate()を呼び出すとint64の型の値が返ってくる。そしてallocate()で割り当てられたidをrelease()に渡して呼び出すときっとプールに戻してくれる(はず)。</p>
<p>そして、構造体のメンバーから察すると、minValue以上、maxValue未満の範囲でint64のidを割り当ててくれる。そして要らなくなったidを戻すとちゃんとプールに戻してくれて再利用可能な状態にしてくれる。</p>
<p>こんなところでしょうか。</p>
<p>ざっくりした割り当ての方法はここで実装されていそうです。しかしint64という型のままだとIPv4の場合はまだおさまるとして、IPv6の時には困りますね。
このあたりの型変換部分はきっとIPAllocator側でなんとかしているに違いありません。
見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewIPAllocator</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cidr</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>IPAllocator</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>allocator</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>IPAllocator</span><span style=color:#000;font-weight:700>{}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ipnet</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParseCIDR</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cidr</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
	<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ipNetwork</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>ipnet</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>g</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>newIDPool</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>&lt;&lt;</span><span style=color:#204a87>int64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>maskBits</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ipNetwork</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mask</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>allocator</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>newIDPoolの引数がめちゃくちゃ怪しいですね。
第一引数がminで第二引数がmaxです。
minに1を指定しているのはいいとして、maxに指定しているのはなんでしょうか。
ネットワークアドレスのマスク値から算出しているようです。
よくみると、これはホストアドレス部分のmax値を最大でも32bitとしてint64の型にしているようです。
IPv6であってもどうやらIPv4と同じ範囲しか割り当てできなさそうな気配ですね。</p>
<p>IPv6の場合は見なかったことにして(え?)、アロケータの初期化の部分で無理やりint64の範囲におさまるようにしていることがわかりました。</p>
<p>ネットワークアドレスはどこで指定しているかというと、smfcfg.yamlの中の以下の<code>>>></code>の部分です。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>userplane_information</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># list of userplane information</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>up_nodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># information of userplane node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>gNB1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the name of the node</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the type of the node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>UPF</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># the name of the node</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UPF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the type of the node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>node_id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the IP/FQDN of N4 interface on this UPF (PFCP)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>sNssaiUpfInfos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># S-NSSAI information list for this UPF</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>sNssai</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># S-NSSAI (Single Network Slice Selection Assistance Information)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>sst: 1 # Slice/Service Type (uinteger, range</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000>~255)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>sd: 010203 # Slice Differentiator (3 bytes hex string, range</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>000000</span><span style=color:#000>~FFFFFF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>dnnUpfInfoList</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># DNN information list for this S-NSSAI</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>dnn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>internet</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>pools</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>&gt;&gt;&gt;               - cidr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60.60.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=まとめ>まとめ</h2>
<p>free5GCでは、DHCPでもRADIUSサーバーでもなく、SMFが独自の方式でUEのIPアドレスの割り当てを行っている。</p>
<h2 id=おまけ>おまけ</h2>
<p>私(hirono)だったらisUsedのマップじゃなくてfreeリスト方式にします。
そうすれば割り当ての計算量もO(1)で済みますし解放もO(1)で済みます。</p>
<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
<li>
<a href=https://omni-jp.github.io/blog/2021/08/27/test/ class="btn btn-primary"><span class=mr-1>←</span> 前へ</a>
</li>
<a class="btn btn-primary disabled">次へ <span class=ml-1>→</span></a>
</li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 Open Mobile Network Infra Community All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js integrity=sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script>
<script src=https://omni-jp.github.io/js/main.min.4336f5c7450d414daa09fd36d9d2ee388e558e2874ca0652d706d56846a9dea4.js integrity="sha256-Qzb1x0UNQU2qCf022dLuOI5Vjih0ygZS1wbVaEap3qQ=" crossorigin=anonymous></script>
</body>
</html>