<!doctype html><html lang=ja class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2"><link rel=canonical type=text/html href=https://omni-jp.github.io/blog/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=https://omni-jp.github.io/favicons/favicon.ico>
<link rel=apple-touch-icon href=https://omni-jp.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=https://omni-jp.github.io/favicons/android-192x192.png sizes=192x192>
<title>Blog | OMNI JP</title><meta property="og:title" content="Blog">
<meta property="og:description" content="Docs for Open Mobile Network Infra Community">
<meta property="og:type" content="website">
<meta property="og:url" content="https://omni-jp.github.io/blog/"><meta property="og:site_name" content="OMNI JP">
<meta itemprop=name content="Blog">
<meta itemprop=description content="Docs for Open Mobile Network Infra Community"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Blog">
<meta name=twitter:description content="Docs for Open Mobile Network Infra Community">
<link rel=preload href=https://omni-jp.github.io/scss/main.min.0bf3a2a5ab2cd69979c3f1fda576e6d32e2013c4acd9d77163d19df37a0e190f.css as=style>
<link href=https://omni-jp.github.io/scss/main.min.0bf3a2a5ab2cd69979c3f1fda576e6d32e2013c4acd9d77163d19df37a0e190f.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class="td-section td-blog">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=https://omni-jp.github.io/>
<span class=navbar-logo><svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a"><stop stop-color="#ef2929" offset="0"/><stop stop-color="#ef2929" stop-opacity="0" offset="1"/></linearGradient><radialGradient id="b" cx="30.204" cy="44.565" r="6.566" gradientTransform="matrix(1 0 0 .33846 2.2204e-14 29.482)" gradientUnits="userSpaceOnUse"><stop offset="0"/><stop stop-opacity="0" offset="1"/></radialGradient><radialGradient id="d" cx="27.577" cy="16.049" r="3.8335" gradientTransform="matrix(1.2434 2.1068e-16 -2.1068e-16 1.2434 -6.7138 -3.7428)" gradientUnits="userSpaceOnUse" xlink:href="#a"/><radialGradient id="c" cx="27.577" cy="15.048" r="3.8335" gradientTransform="matrix(1.2434 2.1068e-16 -2.1068e-16 1.2434 -6.7138 -3.7428)" gradientUnits="userSpaceOnUse" xlink:href="#a"/></defs><path d="m20.225 38.956L24.82 24.36l5.3158 14.596" fill="none" stroke="#000" stroke-miterlimit="10"/><path transform="matrix(.68922 0 0 .68922 5.7682 11.069)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="#ef2929" fill-rule="evenodd"/><path transform="matrix(2.3823 0 0 2.3823 -40.922 -20.43)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="none" stroke="url(#d)" stroke-miterlimit="10" stroke-width="1.1813"/><path transform="matrix(4.6576 0 0 4.6576 -103.67 -62.761)" d="m30.911 18.605a3.3335 3.3335.0 11-6.667.0 3.3335 3.3335.0 116.667.0z" fill="none" stroke="url(#c)" stroke-miterlimit="10" stroke-width=".60421"/><path transform="matrix(1.5677 0 0 1.5677 -22.257 -31.996)" d="m36.77 44.565a6.566 2.2223.0 11-13.132.0 6.566 2.2223.0 1113.132.0z" fill="url(#b)" fill-rule="evenodd" opacity=".1765"/><path d="m23.812 28.572 2.9075.85514-4.2757 2.9075 5.8149 1.5392-7.1832 2.9075 8.5514.85514" fill="none" stroke="#000" stroke-linejoin="bevel" stroke-miterlimit="10"/></svg></span><span class="text-uppercase font-weight-bold">OMNI JP</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=https://omni-jp.github.io/><span class=active>Home</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://omni-jp.github.io/events/><span>Events</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=https://omni-jp.github.io/blog/><span class=active>Blog</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=https://omni-jp.github.io/blog/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Blog</h1>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-0943ca2766d5147212e59bdc7800c6f7>5GのOSSってどこまで使えるの？</h1>
<div class="td-byline mb-4">
<time datetime=2022-02-12 class=text-muted>Saturday, February 12, 2022</time>
</div>
<h2 id=はじめに>はじめに</h2>
<p>5Gあるいは5Gサービスと聞くとモバイルキャリアにより提供されるネットワークサービスで、大手ベンダ製品を使ってモバイルネットワークが構築されているイメージを持たれる方も多いのではないでしょうか。</p>
<p>最近では、5Gネットワークをオープンソースソフトウェア（以下、OSS）で実現する動きが出始めており、個人でも手軽に5G環境を構築することが可能となっています。</p>
<p>本記事では、5GのOSSについて紹介したいと思います。</p>
<h2 id=そもそもモバイルネットワークとは>そもそも、モバイルネットワークとは?</h2>
<p>「端末 (User Equipment)」、「無線アクセスネットワーク (Radio Access Network) 」、「コアネットワーク (Core Network)」の３要素から構成される無線通信設備を指しています。</p>
<p>端末＝スマホ、無線アクセスネットワーク＝基地局、コアネットワーク＝認証サーバやルータ等をイメージするとわかりやすいかと思います。</p>
<p><img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/490507/6fccda6e-db9a-3fb3-0fcb-3645d1c92d63.png alt=image.png></p>
<h2 id=5gのossについて>5GのOSSについて</h2>
<p>5GのOSSについて、構成要素（UE/RAN/CN）ごとにそれぞれコミュニティがあり、開発が行われています。</p>
<h3 id=ran>RAN</h3>
<p>代表的な、OpenAirInterfaceCとUERANSIMについて記載します。それ以外にも、srsRANやSD-RANe等のOSSがあります。</p>
<ul>
<li>
<p><a href=https://gitlab.eurecom.fr/oai/openairinterface5g/ target=_blank rel="nofollow noopener">OAI-RAN</a></p>
<ul>
<li>OpenAirInterface Software Alliance(OSA)が提供する3GPPプロトコルに準拠した無線アクセスネットワーク系（eNB/gNB/UE）のソフトウェア</li>
<li>3GPP仕様に則り開発されているため、リファレンスコードとしても利用される</li>
</ul>
</li>
<li>
<p><a href=https://github.com/aligungr/UERANSIM target=_blank rel="nofollow noopener">UERANSIM</a></p>
<ul>
<li>オープンソースの5G端末（UE）や無線アクセスネットワーク（RAN）を実装</li>
<li>主にコアネットワークと接続するための上位レイヤーのプロトコル(NGAP,NASなど)が実装されている</li>
</ul>
</li>
</ul>
<p><img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/490507/b4f8e37d-5b9c-d86f-9d2c-77907c322104.png alt=image.png></p>
<h3 id=cn>CN</h3>
<p>代表的な、free5GCとOpen5GSについて記載します。それ以外にも、magmaやSD-Core等、様々なOSSがあります。</p>
<ul>
<li>
<p><a href=https://github.com/free5gc/free5gc target=_blank rel="nofollow noopener">free5GC</a></p>
<ul>
<li>3GPP Realse15に準拠したオープンソースソフトウェアの5Gコアであり、StandAlone（SA）構成に対応</li>
<li>様々なネットワークファンクションを実装（NRF/AMF/AUSF/SMF/PCF/UDM/UDR/NSSF/UPF/N3IWF）</li>
<li>コミュニティの動きも活発で、「<a href=https://forum.free5gc.org/ target=_blank rel="nofollow noopener">free5GC forum</a>」も存在</li>
</ul>
</li>
<li>
<p><a href=https://github.com/open5gs/open5gs target=_blank rel="nofollow noopener">Open5GS</a></p>
<ul>
<li>C言語で実装された、オープンソースソフトウェアの5Gコア及びEPC</li>
<li>3GPP Realse16に準拠し、StandAlone（SA）構成に対応</li>
</ul>
</li>
<li>
<p><a href=https://gitlab.eurecom.fr/oai/cn5g target=_blank rel="nofollow noopener">OAI-CN</a></p>
<ul>
<li>OpenAirInterface Software Alliance(OSA)が提供する3GPPプロトコルに準拠したコアネットワーク系（EPC and 5G）のソフトウェア</li>
<li>3GPP仕様に則り開発されているため、リファレンスコードとしても利用される</li>
</ul>
</li>
<li>
<p><a href=https://github.com/magma target=_blank rel="nofollow noopener">magma</a></p>
<ul>
<li>新興国にコネクティビティを届けることを目的に開発が始まったOSS。EPCの機能(A-GW)だけではなく集中管理機能(Orchestrator)やMNOとの連携機能(F-GW)を有する。</li>
<li>5Gコアについては、Telecom Infra Projectと連携して最小構成版Minimum Viable Core(MVC版)を開発中。</li>
</ul>
</li>
</ul>
<p><img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/490507/394eec47-1f6c-461c-3531-74e2b12465a6.png alt=image.png></p>
<h2 id=5gのossってどこまで使えるの>5GのOSSってどこまで使えるの？</h2>
<p>5GのOSSも様々なコミュニティで開発が進んでいる状況で、群雄割拠の状態です。
OSS実装の完成度や、特徴について、<a href=https://github.com/free5gc/free5gc target=_blank rel="nofollow noopener">free5GC</a>を例に記載します。
<img src=https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/490507/29ee0192-3c65-e110-ba51-e202b43ef1ce.png alt=image.png></p>
<ul>
<li>小規模に実証実験を行うレベルまでは、5GコアのOSSも成長してきており、5G特有の機能・実装も進んでいます。</li>
<li>構築も簡単で導入しやすいのですが、商用を見据えると、性能面や運用面でまだまだ課題が残る状況です。</li>
</ul>
<h2 id=5gのoss関連で困ったことがあったら>5GのOSS関連で困ったことがあったら</h2>
<p>モバイルネットワークに関連するOSSの開発者・ユーザ同士で情報交換や新たな繋がりを形成する場として、<a href=https://omni-jp.github.io/ target=_blank rel="nofollow noopener">Open Mobile Network Infra Community</a>を活用してみてはいかがでしょうか。</p>
<h2 id=最後に>最後に</h2>
<p>5GのOSSにより、モバイルネットワークを自営でかつ簡単に構築可能になりつつあります。
この機会にお手元のPCで5G環境を構築してみてはいかがでしょうか？</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-34aa9650bf7e12b81c225b186ec9840c>UEのIPアドレスの割り当て -- free5GC編 --</h1>
<div class="td-byline mb-4">
<time datetime=2021-11-25 class=text-muted>Thursday, November 25, 2021</time>
</div>
<h2 id=はじめに>はじめに</h2>
<p>5GではUEのIPアドレスは、どのような仕組みで割り当てられるのでしょうか?
5GCがDHCPサーバーの機能を保有しているのでしょうか?
はたまた、5GCとは別にRADIUSサーバーが存在しており、5GCとRADIUSサーバーが連携することでIPアドレスが割り当てられるのでしょうか?</p>
<p>UEのIPアドレスの割り当てについて、free5GCではどのように実現しているのか解説したいと思います。</p>
<h2 id=5gの規格ではどうなっているのか>5Gの規格ではどうなっているのか?</h2>
<p>TS 23.501の5.8.2.2 UE IP Address Managementで詳細な仕様が述べられていますが、ざっくりまとめると以下の仕様になっています。</p>
<ul>
<li>NGAP/NASを通してUEとSMFの間でPDU Session Typeがやりとりされる。</li>
<li>PDU Session TypeによってIPv4かIPv6か決まる。</li>
<li>IPアドレスの割り当ては大きくわけて2種類ある。
<ol>
<li>PDU Session確立後にDHCPもしくはDN-AAAを利用してIPアドレスの割り当てを行う。</li>
<li>PDU Sessionの確立中にSMFがSM NAS Signalingを介してUEのIPアドレスを送信する。</li>
</ol>
</li>
</ul>
<p>DHCPやDN-AAA以外にもSMFが割り当てるという仕様も存在することがわかりました。
では実際にfree5GCではどのような実装になっているのか追ってみたいと思います。</p>
<h2 id=パケットキャプチャで確認>パケットキャプチャで確認</h2>
<p>UERANSIMとfree5GCで簡単な構成を組んでパケットをキャプチャして確認してみます。</p>
<p>DHCPやDN-AAAであれば、N3のU-Plane側でそれぞれのプロトコルのやりとりがあるはずです。 一方で、SMFが割り当てる方式であればSM NAS Signalingの中にUEのIPアドレスが入っていることが確認できるはずです。</p>
<p>N3のU-Plane側のキャプチャを見てみましょう。</p>
<p><img src=n3.png alt=Pic></p>
<p>UEのIPアドレスが確定した状態のパケットしかありません。</p>
<p>今度はN1/N2のC-Plane側のキャプチャを見てみましょう。</p>
<p><img src=nas-signaling.png alt=Pic></p>
<p>UEからのPDU Session Establish requestに対する応答で、NASの中にPDU Addressフィールドがあり、そこにUEのIPアドレスが入っていることが確認できます。</p>
<p>free5GCではDHCP/DN-AAAではなくSMFがUEのIPアドレスを割り当てる実装になっていることがわかりました。</p>
<h2 id=smfの実装を追ってみる>SMFの実装を追ってみる</h2>
<p>SMFのディレクトリを探索してみましょう。</p>
<pre tabindex=0><code>github.com/free5gc/smf/
   +- context/
      +- ip_allocator.go
</code></pre><p>contextディレクトリ配下にip_allocator.goという、そのものズバリなソースコードがありますね。まずは構造体を見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>IPAllocator</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>ipNetwork</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IPNet</span>
	<span style=color:#000>g</span>         <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>いかにもIPアドレスを割り当てそうな名前の構造体です。
メンバーとしてipNetworkという名前のネットワークアドレスとgという名前のIPアドレスのプールらしきものを保有しています。
この構造体を使って割り当てを行っていると考えて間違いないでしょう。</p>
<p>ネットワークアドレスはわかるとして、この_IDPoolとは具体的になにものなのか見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>_IDPool</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>minValue</span> <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>maxValue</span> <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>isUsed</span>   <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>bool</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>ふむふむ。最大値と最小値らしきものを保有してますね。
他にもisUsedというboolean型のマップも持っています。これはIPアドレスが実際に使用されているかどうかを判定するためのものでしょうか。
それにしても不思議です。IPアドレスを表現する型であれば4byteか16byteのbyte列となるはずです。しかし、なぜかint64になっています。</p>
<p>int64の謎は後で詳しく調べることにして、この_IDPoolのメソッドを見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>allocate</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>minValue</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>maxValue</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>exist</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>];</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>exist</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;No available value range to allocate id&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_IDPool</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>release</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87>delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isUsed</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>このメソッドからわかることは、allocate()を呼び出すとint64の型の値が返ってくる。そしてallocate()で割り当てられたidをrelease()に渡して呼び出すときっとプールに戻してくれる(はず)。</p>
<p>そして、構造体のメンバーから察すると、minValue以上、maxValue未満の範囲でint64のidを割り当ててくれる。割り当ては常にminValueから順番に探索していき、使用していない最も小さい値を返す。
要らなくなったidをreleaseに渡すとプールに戻してくれて再利用可能な状態にしてくれる。</p>
<p>こんなところでしょうか。</p>
<p>ざっくりした割り当ての方法はここで実装されていそうです。しかしint64という型のままだとIPv4の場合はまだおさまるとして、IPv6の時には困りますね。
このあたりの型変換部分はきっとIPAllocator側でなんとかしているに違いありません。
見てみましょう。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewIPAllocator</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cidr</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>IPAllocator</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>allocator</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>IPAllocator</span><span style=color:#000;font-weight:700>{}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ipnet</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParseCIDR</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cidr</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
	<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ipNetwork</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>ipnet</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>g</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>newIDPool</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>&lt;&lt;</span><span style=color:#204a87>int64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>maskBits</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>allocator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ipNetwork</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mask</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>allocator</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>newIDPoolの引数がめちゃくちゃ怪しいですね。
第一引数がminで第二引数がmaxです。
minに1を指定しているのはいいとして、maxに指定しているのはなんでしょうか。
ネットワークアドレスのマスク値から算出しているようです。
よくみると、これはホストアドレス部分のmax値を最大でも32bitとしてint64の型にしているようです。
IPv6であってもどうやらIPv4と同じ範囲しか割り当てできなさそうな気配ですね。</p>
<p>IPv6の場合は見なかったことにして(え?)、アロケータの初期化の部分で無理やりint64の範囲におさまるようにしていることがわかりました。</p>
<p>ネットワークアドレスはどこで指定しているかというと、smfcfg.yamlの中の以下の<code>>>></code>の部分です。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>userplane_information</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># list of userplane information</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>up_nodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># information of userplane node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>gNB1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the name of the node</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the type of the node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>UPF</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># the name of the node</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UPF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the type of the node (AN or UPF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>node_id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># the IP/FQDN of N4 interface on this UPF (PFCP)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>sNssaiUpfInfos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># S-NSSAI information list for this UPF</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>sNssai</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># S-NSSAI (Single Network Slice Selection Assistance Information)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>sst: 1 # Slice/Service Type (uinteger, range</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000>~255)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>sd: 010203 # Slice Differentiator (3 bytes hex string, range</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>000000</span><span style=color:#000>~FFFFFF)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>dnnUpfInfoList</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># DNN information list for this S-NSSAI</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>dnn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>internet</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>pools</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>&gt;&gt;&gt;               - cidr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60.60.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=まとめ>まとめ</h2>
<ul>
<li>free5GCでは、DHCPでもRADIUSサーバーでもなく、SMFが独自の方式でUEのIPアドレスの割り当てを行っている。</li>
<li>free5GCのSMFのIPアドレス割り当ての実装では、IPアドレスプールの中で最も小さい値が割り当てられるようになっている。</li>
</ul>
<h2 id=おまけ>おまけ</h2>
<p>私(hirono)だったらisUsedのマップじゃなくてfreeリスト方式にします。
そうすれば割り当ての計算量もO(1)で済みますし解放もO(1)で済みます。</p>
<p>例えばこんな感じです。
<a href=https://gist.github.com/khirono/3c7b80e10e309006c4a0ec890b13dbc5 target=_blank rel="nofollow noopener">https://gist.github.com/khirono/3c7b80e10e309006c4a0ec890b13dbc5</a></p>
<p>int64をやめて[]byteにするとかまだまだ改善の余地はあります。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2d1ee9fe9f63bae9ad08a135fd5a7665>Test</h1>
<div class="td-byline mb-4">
<time datetime=2021-08-27 class=text-muted>Friday, August 27, 2021</time>
</div>
<h1 id=blog-test>BLOG TEST</h1>
<ul>
<li>list</li>
</ul>
<p><img src=test.png alt=Pic></p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/omni_infra_jp>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/omni-jp>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://join.slack.com/t/omni-jp/shared_invite/zt-nrwl8rw3-gZIS1FckzeQ2efagTrWUpA>
<i class="fab fa-slack"></i>
</a>
</li>
</ul>
<small class=text-white>運営への問い合わせ: omni.infra.jp[AT]gmail.com</small>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 Open Mobile Network Infra Community All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js integrity=sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script>
<script src=https://omni-jp.github.io/js/main.min.4336f5c7450d414daa09fd36d9d2ee388e558e2874ca0652d706d56846a9dea4.js integrity="sha256-Qzb1x0UNQU2qCf022dLuOI5Vjih0ygZS1wbVaEap3qQ=" crossorigin=anonymous></script>
</body>
</html>